# AsciiDoc Validator

## Обзор системы

AsciiDoc Validator — это высокопроизводительный и расширяемый сервис для автоматической проверки документации в формате AsciiDoc. Проект призван упростить контроль качества технических документов, обеспечивая:

- **Синтаксическую валидацию** заголовков, списков, таблиц, блоков кода и ссылок по настраиваемым правилам
- **Парсинг и структурированный анализ** содержимого AsciiDoc-файлов
- **Валидацию относительно исходного кода** для обеспечения согласованности документации и кода
- **Генерацию детализированных отчётов** о найденных проблемах
- **Гибкую настройку** через YAML-конфигурации

## Расширенная архитектура и компоненты

### Основные компоненты

```
.
├── app
│   ├── main.py                               # Точка входа: настройка FastAPI
│   ├── config
│   │   └── configuration_manager.py          # Управление конфигурацией
│   ├── controllers
│   │   └── validation_controller.py          # REST API контроллеры
│   ├── models
│   │   ├── validation_report.py              # Модели отчетов валидации
│   │   ├── validation_rule.py                # Модели правил валидации
│   │   └── code_structure.py                 # Модели структуры кода
│   ├── services
│   │   ├── documentation_parser.py           # Парсер AsciiDoc
│   │   ├── report_generator.py               # Генератор отчетов
│   │   ├── validation_rule_engine.py         # Движок правил валидации
│   │   ├── source_code_analyzer.py           # Анализатор исходного кода
│   │   ├── code_documentation_matcher.py     # Сопоставление кода и документации
│   │   ├── analyzers
│   │   │   ├── code_analyzer.py              # Базовый интерфейс анализатора
│   │   │   ├── language_specific_analyzer.py # Базовый класс для языковых анализаторов
│   │   │   ├── analyzer_factory.py           # Фабрика анализаторов
│   │   │   ├── java_analyzer.py              # Анализатор Java кода
│   │   │   └── python_analyzer.py            # Анализатор Python кода
│   │   └── validators
│   │       └── syntax_validator.py           # Валидатор синтаксиса AsciiDoc
│   └── utils
│       └── logging_utils.py                  # Утилиты логирования
└── config                                    # Конфигурация
    ├── app_config.yaml                       # Настройки приложения
    └── validation_rules.yaml                 # Правила валидации
```

### Новые компоненты

#### Models
- **code_structure.py** — модели для представления структуры кода (классы, методы, параметры)

#### Services
- **source_code_analyzer.py** — анализатор исходного кода на различных языках
- **code_documentation_matcher.py** — сопоставление кода и документации для проверки соответствия
- **analyzers/**
  - **code_analyzer.py** — базовый интерфейс для всех анализаторов кода
  - **language_specific_analyzer.py** — базовый класс для языко-специфичных анализаторов
  - **analyzer_factory.py** — фабрика для создания нужного анализатора по типу файла
  - **java_analyzer.py** — анализатор Java кода
  - **python_analyzer.py** — анализатор Python кода

## Принципы работы системы

### Базовая валидация документации (POST /api/v1/validate)

1. **Прием и проверка файла**
   - Получение файла AsciiDoc через endpoint `/api/v1/validate`
   - Проверка расширения файла (.adoc, .asciidoc)

2. **Синтаксический анализ**
   - Валидация синтаксиса AsciiDoc через `DocumentationParser.validate_syntax()`
   - При ошибках синтаксиса — возврат HTTP 400 с деталями

3. **Структурный анализ**
   - Парсинг документа в структурированное представление через `DocumentationParser.parse()`
   - Извлечение разделов, метаданных, оглавления

4. **Применение правил валидации**
   - Применение правил из конфигурации через `ValidationRuleEngine.validate()`
   - Генерация списка проблем различных типов (SYNTAX, SEMANTIC, COMPLETENESS, QUALITY)

5. **Формирование отчета**
   - Создание отчета о валидации через `ReportGenerator`
   - Возврат результата в формате JSON или summary

### Расширенная валидация с проверкой соответствия коду (POST /api/v1/validate-with-code)

1. **Прием и проверка файлов**
   - Получение файла документации (doc_file) и файла исходного кода (code_file)
   - Проверка расширений файлов

2. **Анализ документации**
   - Валидация синтаксиса AsciiDoc
   - Парсинг документа в структурированное представление

3. **Анализ исходного кода**
   - Определение языка программирования по расширению файла
   - Выбор соответствующего анализатора кода через `AnalyzerFactory`
   - Парсинг исходного кода в унифицированную структуру `CodeStructure`

4. **Сопоставление кода и документации**
   - Извлечение методов и параметров из кода (`CodeDocumentationMatcher._extract_code_methods()`)
   - Извлечение методов и параметров из документации (`CodeDocumentationMatcher._extract_doc_methods()`)
   - Сопоставление методов и выявление несоответствий

5. **Анализ соответствия API**
   - Извлечение API-эндпоинтов из кода (`CodeDocumentationMatcher._extract_code_endpoints()`)
   - Извлечение API-эндпоинтов из документации (`CodeDocumentationMatcher._extract_doc_endpoints()`)
   - Сопоставление API-эндпоинтов и выявление несоответствий

6. **Формирование комплексного отчета**
   - Объединение результатов синтаксической валидации и проверки соответствия
   - Возврат структурированного отчета с классификацией проблем

## Анализ исходного кода

### Поддерживаемые языки программирования

- **Java** — полная поддержка классов, методов, аннотаций и Spring контроллеров
- **Python** — поддержка функций, классов, декораторов и Flask/FastAPI маршрутов
- **В разработке**: JavaScript, TypeScript, C#

### Процесс анализа кода

1. **Определение языка**
   - Анализ расширения файла (.java, .py, и т.д.)
   - Выбор соответствующего анализатора через `AnalyzerFactory`

2. **Парсинг кода**
   - Java: использование библиотеки `javalang` для создания AST
   - Python: использование модуля `ast` для парсинга кода

3. **Извлечение структуры**
   - Формирование унифицированного представления `CodeStructure`
   - Извлечение классов, методов, полей, параметров
   - Определение API-эндпоинтов через аннотации/декораторы

4. **Анализ API-контроллеров**
   - Java: анализ аннотаций Spring (@Controller, @RequestMapping, и т.д.)
   - Python: анализ декораторов Flask/FastAPI (@app.route, @app.get, и т.д.)

## Извлечение информации из документации

### Гибкий алгоритм извлечения методов

Обновлённый `CodeDocumentationMatcher._extract_doc_methods()` использует несколько подходов:

1. **Определение имени класса**
   - Анализ заголовка документации
   - Поиск в содержимом документа
   - Анализ блоков кода

2. **Определение разделов с методами**
   - Поиск секций-контейнеров ("Методы класса", "API", и т.д.)
   - Анализ иерархии и вложенности секций

3. **Идентификация методов**
   - Шаблоны заголовков ("Метод X", "Method X")
   - Анализ содержимого секций на наличие сигнатур методов
   - Эвристики для определения методов по косвенным признакам

4. **Извлечение параметров**
   - Поддержка различных форматов списков параметров
   - Обработка javadoc-стиля (@param)
   - Извлечение из сигнатур методов в блоках кода

### Алгоритм сопоставления кода и документации

1. **Сопоставление методов**
   - Поиск недокументированных методов (в коде, но не в документации)
   - Поиск методов, описанных в документации, но отсутствующих в коде

2. **Сопоставление параметров**
   - Проверка наличия всех параметров метода в документации
   - Проверка соответствия типов параметров
   - Проверка соответствия обязательности параметров

3. **Сопоставление API-эндпоинтов**
   - Проверка наличия всех API-эндпоинтов в документации
   - Проверка соответствия HTTP-методов
   - Проверка соответствия параметров запросов

## Конфигурация и настройка

### Базовая конфигурация приложения (app_config.yaml)

```yaml
service:
  name: AsciiDoc Validator
  version: 0.1.0
  
server:
  host: 0.0.0.0
  port: 8000
  
logging:
  level: INFO
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  
validation:
  max_file_size_mb: 10
  timeout_seconds: 60
  enable_autocorrection: false
```

### Расширенная конфигурация правил (validation_rules.yaml)

```yaml
# Правила синтаксической валидации
- id: SYNTAX-001
  name: AsciiDoc Headers Validation
  description: Проверка корректности заголовков AsciiDoc
  type: SYNTAX
  severity: ERROR
  config:
    header_pattern: "^={1,6}\\s.+$"
    min_length: 3
    max_length: 100

# ... прочие правила синтаксической валидации ...

# Правила проверки полноты документации
- id: COMPLETENESS-METHOD-001
  name: Method documentation completeness
  description: |
    Убедиться, что каждый public-метод из Java-кода задокументирован в AsciiDoc.
  type: COMPLETENESS
  severity: ERROR
  config:
    # Отделяем имя класса от имени метода
    method_name_pattern: "([^.]+)\\.([^.]+)"
    # Методы определения секций с описаниями методов
    method_section_markers:
      - type: "title_pattern"
        pattern: "Метод\\s+{method_name_short}"
      - type: "title_pattern"
        pattern: "Method\\s+{method_name_short}"
      - type: "title_exact"
        pattern: "{method_name_short}"
      - type: "content_pattern"
        pattern: "```\\w*\\s*(?:public|private|protected)?\\s+\\w+\\s+{method_name_short}\\s*\\("
    # ... и другие параметры конфигурации ...
```

## Использование API

### Базовая валидация документации

```bash
curl -X POST "http://localhost:8000/api/v1/validate" \
  -H "accept: application/json" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@path/to/example.adoc" \
  -F "format=json"
```

### Расширенная валидация с проверкой соответствия коду

```bash
curl -X POST "http://localhost:8000/api/v1/validate-with-code" \
  -H "Content-Type: multipart/form-data" \
  -F "doc_file=@path/to/example.adoc" \
  -F "code_file=@path/to/Example.java" \
  -F "format=json"
```

## Пример результата валидации с проверкой соответствия коду

```json
{
  "validation_id": "93c6c91d-8a86-4f52-b961-bd5bccbd07af",
  "documentation_source": "calculator.adoc",
  "timestamp": "2025-05-07T10:23:51.430794",
  "issues": [
    {
      "id": "COMPLETENESS-METHOD-001-1",
      "type": "COMPLETENESS",
      "location": {
        "section": "Документация для класса Calculator"
      },
      "issue": "Метод 'Calculator.divide' не описан в документации"
    },
    {
      "id": "SEMANTIC-PARAM-003-1",
      "type": "SEMANTIC",
      "location": {
        "line": 35,
        "section": "Метод add"
      },
      "issue": "Параметр 'c' метода 'add' описан в документации, но отсутствует в коде. Возможно, это устаревшая документация или ошибка генерации LLM."
    }
  ],
  "corrections": [],
  "summary": {
    "total_issues": 2,
    "corrected_issues": 0,
    "skipped_issues": 0
  },
  "status": "INVALID"
}
```

## Заключение

AsciiDoc Validator представляет собой мощный инструмент для обеспечения качества технической документации. Благодаря новым возможностям проверки соответствия между документацией и исходным кодом, система может обнаруживать различные типы несоответствий, помогая поддерживать документацию в актуальном и корректном состоянии.

Гибкая архитектура системы позволяет легко расширять поддержку новых языков программирования и форматов документации, а настраиваемые правила валидации обеспечивают адаптацию к различным стилям и требованиям проектов.